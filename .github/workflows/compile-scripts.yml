name: compile-papyrus-scripts
on: 
  workflow_dispatch:
    inputs:
        version:
          description: 'Which version should be build against? Defaults to latest'
          required: false
          default: '1.8.86.0'

jobs:
    compile-scripts:
        runs-on: windows-latest
        steps: 
            - name: Checkout
              uses: actions/checkout@v4

            - name: Fetch Caprica 0.3.0
              shell: bash
              run: gh release download -O .github/Caprica.7z -p '*.7z' -R Orvid/Caprica v0.3.0
              env:
                GH_TOKEN: ${{ github.token }}
            
            - name: Extract Caprica EXE file
              shell: bash
              run: 7z x .github/Caprica.7z -o.github/Caprica

            - name: Fetch vanilla scripts
              shell: bash
              run: |
                curl -L -o .github/Scripts.7z -H "key: ${{ secrets.PAPYRUS_KEY }}" "https://starfieldpatch.dev/api/papyrus/get"
            
            - name: Extract vanilla scripts
              shell: bash
              run: 7z x .github/Scripts.7z -o.github/Scripts

            - name: Run Caprica
              shell: bash
              run: .github/Caprica/Caprica.exe --game starfield --import ".github/Scripts" --output "Scripts" "Scripts/source" -R -q
            
            - name: Upload Output
              uses: actions/upload-artifact@v3
              with: 
                name: compiled-scripts
                path: |
                  scripts/*/*.pex
                  scripts/*/*.psc